{% extends 'base.html' %}

{% block title %}Andamento Operacional{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header & Title -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 text-gray-800">Andamento Operacional</h2>
        <a href="{% url 'operacional:service_order_list' %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-list-ul me-2"></i>Ver Todas OS
        </a>
    </div>

    {% if selected_os %}
    <div class="alert alert-primary d-flex align-items-center shadow-sm" role="alert">
        <i class="bi bi-info-circle-fill me-2 fs-4"></i>
        <div>
            Você está visualizando a OS <strong>#{{ selected_os.id }}</strong> ({{ selected_os.client.name }}).
            Status atual: <strong>{{ selected_os.get_status_display }}</strong>.
        </div>
    </div>
    {% endif %}

    <!-- KPI Row -->
    <div class="row g-3 mb-4">
        <!-- KPI 0: Instalação Pendente -->
        <div class="col-6 col-md">
            <div class="card border-0 shadow-sm h-100 border-start border-4" style="border-color: #20c997 !important;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase text-xs fw-bold mb-1" style="color: #20c997;">Instalação</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ instalacoes_pendentes.count }}</div>
                        </div>
                        <div style="color: #20c997;" class="opacity-50"><i class="bi bi-house-gear fs-2"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KPI 1: Pendentes OS -->
        <div class="col-6 col-md">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-info">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase text-xs fw-bold text-info mb-1">Pendentes OS</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ pendentes_os.count }}</div>
                        </div>
                        <div class="text-info opacity-50"><i class="bi bi-tools fs-2"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KPI 2: Em Execução -->
        <div class="col-6 col-md">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-primary">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase text-xs fw-bold text-primary mb-1">Em Execução</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ em_execucao.count }}</div>
                        </div>
                        <div class="text-primary opacity-50"><i class="bi bi-gear-wide-connected fs-2"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KPI 3: Aguardando Material -->
        <div class="col-6 col-md">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-warning">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase text-xs fw-bold text-warning mb-1">Aguardando Material</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ aguardando_material.count }}</div>
                        </div>
                        <div class="text-warning opacity-50"><i class="bi bi-box-seam fs-2"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KPI 4: Concluídas Hoje -->
        <div class="col-6 col-md">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-dark">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase text-xs fw-bold text-dark mb-1">Concluídas Hoje</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ concluidas_hoje.count }}</div>
                        </div>
                        <div class="text-dark opacity-50"><i class="bi bi-check2-circle fs-2"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KPI 5: Liberação -->
        <div class="col-12 col-md">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase text-xs fw-bold text-success mb-1">Liberação</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ budgets_to_approve|length }}</div>
                        </div>
                        <div class="text-success opacity-50"><i class="bi bi-file-earmark-check fs-2"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Kanban Grid -->
    <div class="row g-3 flex-nowrap overflow-auto pb-3">

        <!-- Column 0: Instalação Pendente (NOVA) -->
        <div class="col-lg col-md-4" style="min-width: 280px;">
            <div class="card h-100 bg-light border-0 shadow-sm">
                <div class="card-header border-bottom fw-bold py-3 d-flex justify-content-between align-items-center text-white"
                    style="background-color: #20c997;">
                    <span><i class="bi bi-house-gear me-2"></i>Instalação Pendente</span>
                    <span class="badge bg-white rounded-pill" style="color: #20c997;">{{ instalacoes_pendentes.count }}</span>
                </div>
                <div class="card-body overflow-auto p-2" style="max-height: 70vh; min-height: 300px;">
                    {% for os in instalacoes_pendentes %}
                    <div id="os-{{ os.id }}" class="card mb-2 border-0 shadow-sm border-start border-4"
                        style="border-color: #20c997 !important;">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="fw-bold fs-6">#{{ os.id|stringformat:"06d" }}</span>
                                <span class="badge bg-light"
                                    style="color: #20c997; font-size: 0.7rem;">Instalação</span>
                            </div>
                            <div class="mb-2">
                                <div class="text-truncate fw-bold text-dark" title="{{ os.client.name }}">{{ os.client.name }}</div>
                                <div class="small" style="color: #20c997;">R$ {{ os.value|floatformat:2 }}</div>
                                {% if os.budget %}
                                <div class="small text-muted mt-1"><i class="bi bi-file-earmark-text me-1"></i>Orç. #{{
                                    os.budget.id|stringformat:"06d" }}</div>
                                {% endif %}
                                {% if os.technician %}
                                <div class="small text-muted mt-1"><i class="bi bi-person me-1"></i>{{ os.technician.get_full_name }}</div>
                                {% else %}
                                <div class="small text-muted mt-1"><i class="bi bi-person-x me-1"></i>Sem técnico</div>
                                {% endif %}
                            </div>
                            <div class="d-grid mt-3">
                                <a href="{% url 'operacional:service_order_detail' os.pk %}"
                                    class="btn btn-sm text-white" style="background-color: #20c997;">Ver Detalhes</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-house-gear fs-1 d-block mb-2"></i>
                        <small>Nenhuma instalação pendente</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Column 1: Pendentes OS (Aberto/Agendado) -->
        <div class="col-lg col-md-4" style="min-width: 280px;">
            <div class="card h-100 bg-light border-0 shadow-sm">
                <div
                    class="card-header bg-white border-bottom fw-bold py-3 text-info d-flex justify-content-between align-items-center">
                    <span>Pendentes OS</span>
                    <span class="badge bg-info bg-opacity-10 text-info rounded-pill">{{ pendentes_os.count }}</span>
                </div>
                <div class="card-body overflow-auto p-2" style="max-height: 70vh; min-height: 300px;">
                    {% for os in pendentes_os %}
                    <div id="os-{{ os.id }}" class="card mb-2 border-0 shadow-sm border-start border-4 border-info">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="fw-bold fs-6">#{{ os.id|stringformat:"06d" }}</span>
                                <small class="text-muted">{{ os.scheduled_date|date:"d/m H:i"|default:"-" }}</small>
                            </div>
                            <div class="mb-2">
                                <div class="text-truncate fw-bold text-dark" title="{{ os.client.name }}">{{ os.client.name }}</div>
                                <div class="small text-muted">{{ os.order_type }}</div>
                                {% if os.technician %}
                                <div class="small text-muted mt-1"><i class="bi bi-person me-1"></i>{{ os.technician.get_full_name }}</div>
                                {% else %}
                                <div class="small text-muted mt-1"><i class="bi bi-person-x me-1"></i>Sem técnico</div>
                                {% endif %}
                            </div>
                            <div class="d-grid mt-3">
                                <a href="{% url 'operacional:service_order_detail' os.pk %}"
                                    class="btn btn-sm btn-outline-info">Ver Detalhes</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <small>Nada pendente</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Column 2: Em Execução -->
        <div class="col-lg col-md-4" style="min-width: 280px;">
            <div class="card h-100 bg-light border-0 shadow-sm">
                <div
                    class="card-header bg-white border-bottom fw-bold py-3 text-primary d-flex justify-content-between align-items-center">
                    <span>Em Execução</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">{{ em_execucao.count }}</span>
                </div>
                <div class="card-body overflow-auto p-2" style="max-height: 70vh; min-height: 300px;">
                    {% for os in em_execucao %}
                    <div id="os-{{ os.id }}"
                        class="card mb-2 border-0 shadow-sm border-start border-4 border-primary {% if selected_os.id == os.id %}ring-4 ring-primary bg-primary bg-opacity-10{% endif %}"
                        {% if selected_os.id == os.id %}style="border: 2px solid #0d6efd !important;" {% endif %}>
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="fw-bold fs-6">#{{ os.id|stringformat:"06d" }}</span>
                                <span class="badge bg-primary">Executando</span>
                            </div>
                            <div class="mb-2">
                                <div class="text-truncate fw-bold text-dark" title="{{ os.client.name }}">{{ os.client.name }}</div>
                                <div class="small text-muted">{{ os.order_type }}</div>
                                {% if os.technician %}
                                <div class="small text-muted mt-1"><i class="bi bi-person me-1"></i>{{ os.technician.get_full_name }}</div>
                                {% endif %}
                            </div>
                            <div class="d-grid mt-3">
                                <a href="{% url 'operacional:service_order_detail' os.pk %}"
                                    class="btn btn-sm btn-outline-primary">Ver Detalhes</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <small>Nada em execução</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Column 3: Aguardando Material -->
        <div class="col-lg col-md-4" style="min-width: 280px;">
            <div class="card h-100 bg-light border-0 shadow-sm">
                <div
                    class="card-header bg-white border-bottom fw-bold py-3 text-warning d-flex justify-content-between align-items-center">
                    <span>Aguardando Material</span>
                    <span class="badge bg-warning bg-opacity-10 text-dark rounded-pill">{{ aguardando_material.count }}</span>
                </div>
                <div class="card-body overflow-auto p-2" style="max-height: 70vh; min-height: 300px;">
                    {% for os in aguardando_material %}
                    <div id="os-{{ os.id }}" class="card mb-2 border-0 shadow-sm border-start border-4 border-warning">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="fw-bold fs-6">#{{ os.id|stringformat:"06d" }}</span>
                                <span class="badge bg-warning text-dark">Material</span>
                            </div>
                            <div class="mb-2">
                                <div class="text-truncate fw-bold text-dark" title="{{ os.client.name }}">{{ os.client.name }}</div>
                                <div class="small text-muted">{{ os.product|default:"-" }}</div>
                                {% if os.technician %}
                                <div class="small text-muted mt-1"><i class="bi bi-person me-1"></i>{{ os.technician.get_full_name }}</div>
                                {% endif %}
                            </div>
                            <div class="d-grid mt-3">
                                <a href="{% url 'operacional:service_order_detail' os.pk %}"
                                    class="btn btn-sm btn-outline-warning text-dark">Ver Detalhes</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <small>Nada aguardando</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Column 4: Concluídas Hoje -->
        <div class="col-lg col-md-4" style="min-width: 280px;">
            <div class="card h-100 border-0 shadow-sm" style="background-color: #f8f9fa;">
                <div
                    class="card-header bg-white border-bottom fw-bold py-3 text-dark d-flex justify-content-between align-items-center">
                    <span>Concluídas Hoje</span>
                    <span class="badge bg-dark bg-opacity-10 text-dark rounded-pill">{{ concluidas_hoje.count }}</span>
                </div>
                <div class="card-body overflow-auto p-2" style="max-height: 70vh; min-height: 300px;">
                    {% for os in concluidas_hoje %}
                    <div id="os-{{ os.id }}" class="card mb-2 border-0 shadow-sm border-start border-4 border-dark">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <span class="fw-bold small">#{{ os.id|stringformat:"06d" }}</span>
                                <small class="text-success fw-bold">{{ os.checkout_time|date:"H:i" }}</small>
                            </div>
                            <div class="mb-1">
                                <div class="text-truncate fw-bold text-dark small" title="{{ os.client.name }}">{{ os.client.name }}</div>
                                {% if os.technician %}
                                <div class="small text-muted" style="font-size: 0.75rem;"><i
                                        class="bi bi-person me-1"></i>{{ os.technician.get_full_name }}</div>
                                {% endif %}
                            </div>
                            <div class="d-grid mt-2">
                                <a href="{% url 'operacional:service_order_detail' os.pk %}"
                                    class="btn btn-xs btn-outline-dark" style="font-size: 0.7rem;">Ver Detalhes</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-check2-all fs-1 d-block mb-2"></i>
                        <small>Nenhuma hoje</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    .card-body::-webkit-scrollbar {
        width: 4px;
    }

    .card-body::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .card-body::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    .card-body::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }

    .btn-xs {
        padding: 0.2rem 0.4rem;
        line-height: 1;
    }
</style>

{% if selected_os %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var element = document.getElementById("os-{{ selected_os.id }}");
        if (element) {
            element.scrollIntoView({ behavior: "smooth", block: "center" });
            element.classList.add("highlight-pulse");
        }
    });
</script>
<style>
    @keyframes pulse-blue {
        0% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }

    .highlight-pulse {
        animation: pulse-blue 2s infinite;
    }
</style>
{% endif %}
{% endblock %}


