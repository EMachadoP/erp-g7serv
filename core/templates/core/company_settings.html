{% extends "base.html" %}
{% load static %}

{% block title %}Configurações do Sistema | G7Serv{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h3 mb-0 text-gray-800">
                <i class="bi bi-gear-fill me-2 text-primary"></i>Configurações do Sistema
            </h2>
            <div>
                <a href="{% url 'financeiro:diagnostico_cora' %}" target="_blank"
                    class="btn btn-outline-primary shadow-sm">
                    <i class="bi bi-lightning-fill me-2"></i>Abrir Diagnóstico Completo
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-primary">Dados da Empresa e Integrações</h6>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <h5 class="mb-3 border-bottom pb-2">Geral</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold small text-uppercase">Nome da Empresa</label>
                            {{ form.name }}
                            {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors }}</div>{% endif
                            %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-uppercase">CNPJ</label>
                            {{ form.cnpj }}
                            {% if form.cnpj.errors %}<div class="text-danger small">{{ form.cnpj.errors }}</div>{% endif
                            %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-uppercase">Logo da Empresa</label>
                        {{ form.logo }}
                        {% if settings.logo %}
                        <div class="mt-2">
                            <img src="{{ settings.logo.url }}" alt="Logo" style="max-height: 100px;"
                                class="img-thumbnail border-0 shadow-sm">
                        </div>
                        {% endif %}
                        {% if form.logo.errors %}<div class="text-danger small">{{ form.logo.errors }}</div>{% endif %}
                    </div>

                    <h5 class="mb-3 border-bottom pb-2 mt-4 text-primary">Banco Cora (Integração v2)</h5>
                    <div class="alert alert-info py-2 small border-0 shadow-sm mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        As configurações abaixo permitem a comunicação segura via mTLS.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold small text-uppercase">Ambiente de Execução</label>
                            {{ form.cora_environment }}
                            <div class="form-text small">Mude para 'Produção' somente após validar as chaves no
                                diagnostico.</div>
                            {% if form.cora_environment.errors %}<div class="text-danger small">{{
                                form.cora_environment.errors }}</div>{% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">Cora Client ID</label>
                        {{ form.cora_client_id }}
                        {% if form.cora_client_id.errors %}<div class="text-danger small">{{ form.cora_client_id.errors
                            }}</div>{% endif %}
                        <div class="form-text small">Obtido no painel de desenvolvedor da Cora (padrao 'int-xxxx').
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">Cora Certificado (Base64)</label>
                        {{ form.cora_cert_base64 }}
                        {% if form.cora_cert_base64.errors %}<div class="text-danger small">{{
                            form.cora_cert_base64.errors }}</div>{% endif %}
                        <div class="form-text small">Conteúdo do arquivo .pem ou .crt em Base64 (incluindo as tags
                            BEGIN/END).</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-uppercase">Cora Chave Privada (Base64)</label>
                        {{ form.cora_key_base64 }}
                        {% if form.cora_key_base64.errors %}<div class="text-danger small">{{
                            form.cora_key_base64.errors }}</div>{% endif %}
                        <div class="form-text small">Conteúdo do arquivo .key em Base64 (incluindo as tags BEGIN/END).
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" id="btnTestarConexao" class="btn btn-outline-info w-100 mb-2">
                                <i class="bi bi-shield-check me-2"></i>Testar Conexão mTLS Agora
                            </button>
                            <div id="resultadoTeste" class="mt-2 small"></div>
                        </div>
                        <div class="col-md-6 d-grid">
                            <button type="submit" class="btn btn-primary px-5 shadow-sm">
                                <i class="bi bi-save me-2"></i>Salvar Configurações
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-light py-3">
                <h6 class="m-0 fw-bold text-dark">Dicas de Segurança e mTLS</h6>
            </div>
            <div class="card-body small">
                <p><strong>Certificados:</strong> Nunca compartilhe sua chave privada. O sistema utiliza mTLS (Mutual
                    TLS) para garantir que apenas seu servidor fale com a Cora.</p>
                <p><strong>BEGIN/END:</strong> Ao converter para Base64, o texto original <strong>deve</strong> conter
                    as tags <code>-----BEGIN...</code>.</p>
                <p><strong>Erro 401:</strong> Credenciais (ID ou Certificado) inválidas para este ambiente.</p>
                <p><strong>Erro 403:</strong> Certificado válido, mas sem permissão de acesso (Verifique o Scopo no
                    painel Cora).</p>
                <hr>
                <p class="mb-0"><strong>Conversão no Windows (PowerShell):</strong><br>
                    <code>[Convert]::ToBase64String([IO.File]::ReadAllBytes('caminho/do/arquivo'))</code>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('btnTestarConexao').addEventListener('click', function () {
        const container = document.getElementById('resultadoTeste');
        container.innerHTML = '<div class="spinner-border spinner-border-sm text-info" role="status"></div> Testando...';

        fetch('{% url "financeiro:diagnostico_cora" %}')
            .then(response => response.text())
            .then(html => {
                container.innerHTML = '<div class="card border-info"><div class="card-body py-2">' + html + '</div></div>';
            })
            .catch(err => {
                container.innerHTML = '<div class="text-danger">Erro ao chamar diagnóstico: ' + err + '</div>';
            });
    });
</script>
{% endblock %}