{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard BI - ERP G7Serv{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header com Resumo -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="h4 font-weight-bold text-dark mb-0">
                <i class="bi bi-speedometer2 me-2"></i>Painel de Business Intelligence
            </h2>
            <p class="text-muted small">Métricas atualizadas em tempo real para tomada de decisão.</p>
        </div>
    </div>

    <!-- Cards de Métricas -->
    <div class="row g-4 mb-4">
        <!-- Card 1: Clientes -->
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-muted small text-uppercase mb-1">Total Clientes Ativos</p>
                            <h3 class="fw-bold mb-0">{{ total_clientes }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="bi bi-people text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: Faturamento -->
        {% if faturamento_mes is not None %}
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-muted small text-uppercase mb-1">Faturamento (Mês)</p>
                            <h3 class="fw-bold mb-0">R$ {{ faturamento_mes|floatformat:2|intcomma }}</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <i class="bi bi-cash-stack text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Card 3: OS Pendentes -->
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-muted small text-uppercase mb-1">OS Pendentes</p>
                            <h3 class="fw-bold mb-0 text-danger">{{ os_pendentes }}</h3>
                        </div>
                        <div class="bg-danger bg-opacity-10 p-3 rounded">
                            <i class="bi bi-tools text-danger fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 4: Contas a Vencer -->
        {% if contas_vencer is not None %}
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-muted small text-uppercase mb-1">Contas a Vencer</p>
                            <h3 class="fw-bold mb-0 text-warning">{{ contas_vencer }}</h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="bi bi-calendar-event text-warning fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Card 5: AI Hoje -->
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-muted small text-uppercase mb-1">Triagens IA (Hoje)</p>
                            <h3 class="fw-bold mb-0 text-info">{{ atendimentos_hoje }}</h3>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded">
                            <i class="bi bi-robot text-info fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 6: OS em Andamento -->
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-muted small text-uppercase mb-1">OS em Andamento</p>
                            <h3 class="fw-bold mb-0 text-primary">{{ os_andamento }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="bi bi-activity text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 7: Importador Inteligente -->
        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm h-100 bg-primary text-white">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Importador Inteligente</h5>
                        <p class="small mb-0 opacity-75">Processe planilhas com IA</p>
                        <a href="{% url 'importador:index' %}" class="btn btn-sm btn-light mt-2 fw-bold">Acessar
                            Agora</a>
                    </div>
                    <i class="bi bi-cloud-arrow-up fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos e Tabelas -->
    <div class="row g-4">
        <!-- Gráfico AI -->
        <div class="col-12 col-xl-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0">Distribuição de Triagens IA</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="aiChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico OS -->
        <div class="col-12 col-xl-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0">Status Operacional (OS)</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="osChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Últimos Atendimentos IA -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Últimas Triagens Studio AI</h5>
                    <span class="badge bg-secondary">Top 5</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0">Data/Hora</th>
                                <th class="border-0">Cliente</th>
                                <th class="border-0">Protocolo</th>
                                <th class="border-0">Setor Triado</th>
                                <th class="border-0 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for atendimento in ultimos_atendimentos %}
                            <tr>
                                <td>{{ atendimento.timestamp|date:"d/m/Y H:i" }}</td>
                                <td>{{ atendimento.cliente_nome }}</td>
                                <td><code>{{ atendimento.protocolo }}</code></td>
                                <td>
                                    {% if atendimento.categoria_detectada == 'orcamento' %}
                                    <span class="badge bg-primary">Comercial</span>
                                    {% elif atendimento.categoria_detectada == 'suporte' %}
                                    <span class="badge bg-success">Suporte</span>
                                    {% elif atendimento.categoria_detectada == 'financeiro' %}
                                    <span class="badge bg-warning text-dark">Financeiro</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Outros</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if atendimento.resolvido %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    {% else %}
                                    <i class="bi bi-clock-history text-muted"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Nenhum atendimento registrado hoje.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfico de Triagem IA (Doughnut)
    const aiCtx = document.getElementById('aiChart').getContext('2d');
    new Chart(aiCtx, {
        type: 'doughnut',
        data: {
            labels: ['Comercial', 'Suporte', 'Financeiro', 'Outros'],
            datasets: [{
                data: [{{ ai_comercial }}, {{ ai_suporte }}, {{ ai_financeiro }}, {{ ai_outros }}],
        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#6b7280'],
        borderWidth: 0
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        },
        cutout: '70%'
    }
    });

    // Gráfico de Status OS (Pie)
    const osCtx = document.getElementById('osChart').getContext('2d');
    new Chart(osCtx, {
        type: 'pie',
        data: {
            labels: ['Pendentes', 'Em Andamento', 'Concluídas'],
            datasets: [{
                data: [{{ os_pendente }}, {{ os_andamento }}, {{ os_concluida }}],
        backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
        borderWidth: 0
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
    });
</script>
{% endblock %}