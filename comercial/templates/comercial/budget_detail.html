{% extends 'base.html' %}

{% block title %}Detalhes do Orçamento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
 <h2>Detalhes do Orçamento</h2>
 <div class="btn-group">
 <a href="{% url 'comercial:budget_list' %}" class="btn btn-outline-secondary">
 <i class="bi bi-arrow-left me-2"></i>Voltar
 </a>
 {% if budget.status == 'Aberto' %}
 <a href="{% url 'comercial:budget_win' budget.pk %}" class="btn btn-success text-white">
 Ganhar / Recusar
 </a>
 {% endif %}
 <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"
 aria-expanded="false">
 Ações
 </button>
 <ul class="dropdown-menu dropdown-menu-end">
 <li><a class="dropdown-item" href="{% url 'comercial:budget_update' budget.pk %}"><i
 class="bi bi-pencil me-2"></i>Editar</a></li>
 <li><a class="dropdown-item" href="{% url 'comercial:budget_pdf' budget.pk %}" target="_blank"><i
 class="bi bi-printer me-2"></i>Imprimir</a></li>
 <li><a class="dropdown-item" href="{% url 'comercial:budget_send_email' budget.pk %}"><i
 class="bi bi-envelope me-2"></i>Enviar por E-mail</a></li>
 <li>
 <hr class="dropdown-divider">
 </li>
 <li><a class="dropdown-item text-danger" href="{% url 'comercial:budget_delete' budget.pk %}"><i
 class="bi bi-trash me-2"></i>Excluir</a></li>
 </ul>
 </div>
</div>

<div class="row">
 <!-- Left Column: Summary -->
 <div class="col-md-3">
 <div class="card border-0 shadow-sm mb-4">
 <div class="card-body text-center">
 <h5 class="text-muted mb-3">{{ budget.id|stringformat:"06d" }}</h5>

 <div class="mb-3">
 {% if budget.status == 'Ganho' %}
 <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">Ganho</span>
 {% elif budget.status == 'Aberto' %}
 <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill">Aberto</span>
 {% elif budget.status == 'Perdido' %}
 <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill">Perdido</span>
 {% else %}
 <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill">{{ budget.status }}</span>
 {% endif %}
 </div>

 <div class="display-6 text-primary mb-3">
 <i class="bi bi-file-earmark-text"></i>
 </div>
 </div>
 <ul class="list-group list-group-flush">
 <li class="list-group-item bg-transparent">
 <small class="text-muted d-block">Cliente</small>
 <strong>{{ budget.client.name }}</strong>
 </li>
 <li class="list-group-item bg-transparent">
 <small class="text-muted d-block">Vendedor</small>
 {{ budget.seller.username|default:"Não informado" }}
 </li>
 <li class="list-group-item bg-transparent">
 <small class="text-muted d-block">Validade</small>
 {{ budget.validity_date|date:"d/m/Y" }}
 </li>
 <li class="list-group-item bg-transparent">
 <small class="text-muted d-block">Data de Abertura</small>
 {{ budget.date|date:"d/m/Y" }}
 </li>
 </ul>
 <div class="card-body border-top">
 <a href="{% url 'comercial:budget_update' budget.pk %}"
 class="btn btn-outline-primary w-100 btn-sm">Editar Dados</a>
 </div>
 </div>
 </div>

 <!-- Right Column: Details -->
 <div class="col-md-9">
 <!-- Info Cards -->
 <div class="row mb-4">
 <div class="col-md-6">
 <div class="card border-0 shadow-sm h-100">
 <div class="card-body">
 <h6 class="card-title text-muted">Total Líquido</h6>
 <h3>R$ {{ budget.total_value|floatformat:2 }}</h3>
 </div>
 </div>
 </div>
 <div class="col-md-6">
 <div class="card border-0 shadow-sm h-100">
 <div class="card-body">
 <h6 class="card-title text-muted">Serviços Recorrentes</h6>
 <h3>R$ 0,00</h3>
 </div>
 </div>
 </div>
 </div>

 <!-- Tabs -->
 <div class="card border-0 shadow-sm">
 <div class="card-header bg-white border-bottom-0 pt-3 px-4">
 <ul class="nav nav-tabs card-header-tabs" id="budgetTabs" role="tablist">
 <li class="nav-item" role="presentation">
 <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
 type="button" role="tab">Informações</button>
 </li>
 <li class="nav-item" role="presentation">
 <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products"
 type="button" role="tab">Produtos</button>
 </li>
 <li class="nav-item" role="presentation">
 <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services"
 type="button" role="tab">Serviços</button>
 </li>
 </ul>
 </div>
 <div class="card-body p-4">
 <div class="tab-content" id="budgetTabsContent">
 <div class="card-body">
 <div class="d-flex justify-content-between mb-2">
 <h6 class="card-title"><i class="bi bi-card-text me-2"></i>Observações</h6>
 </div>
 <div class="text-muted small">
 {{ budget.observation|safe|default:"Nenhuma observação." }}
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Products Tab -->
 <div class="tab-pane fade" id="products" role="tabpanel">
 {% if budget.products.exists %}
 <div class="table-responsive">
 <table class="table table-hover align-middle">
 <thead class="table-light">
 <tr>
 <th>Produto</th>
 <th class="text-center">Qtd</th>
 <th class="text-end">Preço Unit.</th>
 <th class="text-end">Total</th>
 </tr>
 </thead>
 <tbody>
 {% for item in budget.products.all %}
 <tr>
 <td>{{ item.product.name }}</td>
 <td class="text-center">{{ item.quantity }}</td>
 <td class="text-end">R$ {{ item.unit_price|floatformat:2 }}</td>
 <td class="text-end fw-bold">R$ {{ item.total_price|floatformat:2 }}</td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>
 {% else %}
 <div class="text-center py-5 text-muted">
 <i class="bi bi-box-seam display-4 mb-3 d-block"></i>
 <p>Nenhum produto adicionado a este orçamento.</p>
 </div>
 {% endif %}
 </div>

 <!-- Services Tab -->
 <div class="tab-pane fade" id="services" role="tabpanel">
 {% if budget.services.exists %}
 <div class="table-responsive">
 <table class="table table-hover align-middle">
 <thead class="table-light">
 <tr>
 <th>Serviço</th>
 <th class="text-center">Qtd</th>
 <th class="text-end">Preço Unit.</th>
 <th class="text-end">Total</th>
 </tr>
 </thead>
 <tbody>
 {% for item in budget.services.all %}
 <tr>
 <td>{{ item.service.name }}</td>
 <td class="text-center">{{ item.quantity }}</td>
 <td class="text-end">R$ {{ item.unit_price|floatformat:2 }}</td>
 <td class="text-end fw-bold">R$ {{ item.total_price|floatformat:2 }}</td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>
 {% else %}
 <div class="text-center py-5 text-muted">
 <i class="bi bi-tools display-4 mb-3 d-block"></i>
 <p>Nenhum serviço adicionado a este orçamento.</p>
 </div>
 {% endif %}
 </div>
</div>
</div>
</div>
</div>
</div>
{% endblock %}