{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4 py-4">
 <div class="d-flex justify-content-between align-items-center mb-4">
 <h2 class="h4 text-gray-800">Ordens de Serviço</h2>
 <a href="{% url 'operacional:service_order_create' %}" class="btn btn-primary">
 <i class="bi bi-plus-lg me-1"></i> Nova OS
 </a>
 </div>

 <!-- Filters Card -->
 <div class="card border-0 shadow-sm mb-4">
 <div class="card-body p-3">
 <form method="get" class="row g-3">
 <div class="col-md-4">
 <label class="form-label small fw-bold text-muted">Pesquisar</label>
 <div class="input-group input-group-sm">
 <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
 <input type="text" name="search" class="form-control border-start-0"
 placeholder="ID, Condomínio ou Cliente..." value="{{ search_query }}">
 </div>
 </div>
 <div class="col-md-2">
 <label class="form-label small fw-bold text-muted">Status</label>
 <select name="status" class="form-select form-select-sm">
 <option value="">Todos os Status</option>
 {% for value, label in status_choices %}
 <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}
 </option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-2">
 <label class="form-label small fw-bold text-muted">Data</label>
 <input type="date" name="date" class="form-control form-control-sm" value="{{ date_filter }}">
 </div>
 <div class="col-md-4 d-flex align-items-end gap-2">
 <button type="submit" class="btn btn-sm btn-primary px-3">
 <i class="bi bi-filter me-1"></i> Filtrar
 </button>
 <a href="{% url 'operacional:service_order_list' %}" class="btn btn-sm btn-outline-secondary px-3">
 Limpar
 </a>
 </div>
 </form>
 </div>
 </div>

 <!-- Table Card -->
 <div class="card border-0 shadow-sm">
 <div class="card-body p-0">
 <div class="table table-responsive">
 <table class="table table-premium table-hover align-middle mb-0">
 <thead class="table table-premium-light">
 <tr>
 <th class="ps-3" style="width: 80px;">ID</th>
 <th>Cliente</th>
 <th>Descrição / Produto</th>
 <th>Status</th>
 <th>Data</th>
 <th class="text-end pe-3" style="width: 180px;">Ações</th>
 </tr>
 </thead>
 <tbody>
 {% for order in page_obj %}
 <tr>
 <td class="ps-3 fw-bold">#{{ order.id|stringformat:"05d" }}</td>
 <td>
 <div class="fw-bold text-dark">{{ order.client.fantasy_name|default:order.client.name }}
 </div>
 <small class="text-muted">{{ order.client.city }} / {{ order.client.state }}</small>
 </td>
 <td>
 <div class="text-truncate" style="max-width: 250px;" title="{{ order.description }}">
 {{ order.product|default:order.description|truncatewords:10 }}
 </div>
 </td>
 <td>
 {% if order.status == 'COMPLETED' %}
 <span
 class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">Concluído</span>
 {% elif order.status == 'IN_PROGRESS' %}
 <span
 class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle">Em
 Execução</span>
 {% elif order.status == 'WAITING_MATERIAL' %}
 <span
 class="badge rounded-pill bg-warning-subtle text-warning border border-warning-subtle text-dark">Material</span>
 {% elif order.status == 'CANCELED' %}
 <span
 class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">Cancelado</span>
 {% else %}
 <span
 class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">Pendente</span>
 {% endif %}
 </td>
 <td>
 <small class="fw-bold">{{ order.scheduled_date|date:"d/m/Y"|default:order.created_at|date:"d/m/Y" }}</small>
 </td>
 <td class="text-end pe-3">
 <div class="btn-group">
 <a href="{% url 'operacional:operational_progress' %}?os_id={{ order.id }}"
 class="btn btn-sm btn-outline-info" title="Ver no Kanban">
 <i class="bi bi-kanban"></i>
 </a>
 <a href="{% url 'operacional:service_order_detail' order.id %}"
 class="btn btn-sm btn-outline-primary" title="Detalhes">
 <i class="bi bi-eye"></i>
 </a>
 <a href="{% url 'operacional:service_order_update' order.id %}"
 class="btn btn-sm btn-outline-warning" title="Editar">
 <i class="bi bi-pencil"></i>
 </a>
 {% if order.status != 'COMPLETED' and order.status != 'CANCELED' %}
 <button type="button" class="btn btn-sm btn-outline-danger"
 onclick="confirmCancel('{{ order.id }}', '{% url 'operacional:service_order_cancel' order.id %}')"
 title="Cancelar OS">
 <i class="bi bi-x-circle"></i>
 </button>
 {% endif %}
 </div>
 </td>
 </tr>
 {% empty %}
 <tr>
 <td colspan="6" class="text-center py-5 text-muted">
 <i class="bi bi-search fs-1 d-block mb-3 opacity-25"></i>
 Nenhuma ordem de serviço encontrada com os filtros atuais.
 </td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>
 </div>
 </div>

 <!-- Pagination -->
 {% if page_obj.has_other_pages %}
 <nav aria-label="Navegação de página" class="mt-4">
 <ul class="pagination pagination-sm justify-content-center">
 {% if page_obj.has_previous %}
 <li class="page-item">
 <a class="page-link shadow-sm"
 href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}&date={{ date_filter }}">
 <i class="bi bi-chevron-left"></i> Anterior
 </a>
 </li>
 {% else %}
 <li class="page-item disabled">
 <span class="page-link shadow-sm"><i class="bi bi-chevron-left"></i> Anterior</span>
 </li>
 {% endif %}

 {% for i in page_obj.paginator.page_range %}
 {% if page_obj.number == i %}
 <li class="page-item active shadow-sm"><span class="page-link">{{ i }}</span></li>
 {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %} <li class="page-item"><a
 class="page-link shadow-sm"
 href="?page={{ i }}&search={{ search_query }}&status={{ status_filter }}&date={{ date_filter }}">{{ i }}</a></li>
 {% endif %}
 {% endfor %}

 {% if page_obj.has_next %}
 <li class="page-item">
 <a class="page-link shadow-sm"
 href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_filter }}&date={{ date_filter }}">
 Próximo <i class="bi bi-chevron-right"></i>
 </a>
 </li>
 {% else %}
 <li class="page-item disabled">
 <span class="page-link shadow-sm">Próximo <i class="bi bi-chevron-right"></i></span>
 </li>
 {% endif %}
 </ul>
 </nav>
 {% endif %}
</div>

<style>
 .bg-success-subtle {
 background-color: #d1e7dd !important;
 }

 .bg-primary-subtle {
 background-color: #cfe2ff !important;
 }

 .bg-warning-subtle {
 background-color: #fff3cd !important;
 }

 .bg-danger-subtle {
 background-color: #f8d7da !important;
 }

 .bg-secondary-subtle {
 background-color: #e2e3e5 !important;
 }

 .text-success {
 color: #0f5132 !important;
 }

 .text-primary {
 color: #084298 !important;
 }

 .text-warning {
 color: #664d03 !important;
 }

 .text-danger {
 color: #842029 !important;
 }

 .table-hover tbody tr:hover {
 background-color: rgba(13, 110, 253, 0.03) !important;
 }

 .btn-group .btn {
 padding: 0.25rem 0.5rem;
 }
</style>

<script>
 function confirmCancel(osId, cancelUrl) {
 if (confirm("Tem certeza que deseja CANCELAR a Ordem de Serviço #" + osId + "?\nEsta ação mudará o status para Cancelado.")) {
 window.location.href = cancelUrl;
 }
 }
</script>
{% endblock %}