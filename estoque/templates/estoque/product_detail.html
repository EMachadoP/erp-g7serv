{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
 <div>
 <nav aria-label="breadcrumb">
 <ol class="breadcrumb mb-1">
 <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Início</a></li>
 <li class="breadcrumb-item"><a href="{% url 'estoque:product_list' %}">Produtos</a></li>
 <li class="breadcrumb-item active" aria-current="page">Detalhes do Produto</li>
 </ol>
 </nav>
 <h2 class="text-secondary">Detalhes do Produto</h2>
 </div>
 <div>
 <a href="{% url 'estoque:product_list' %}" class="btn btn-outline-secondary me-2"><i
 class="bi bi-arrow-left"></i> Voltar</a>
 <a href="{% url 'estoque:movement_create' %}?product={{ product.id }}" class="btn btn-primary"><i
 class="bi bi-arrow-left-right"></i> Nova Movimentação</a>
 </div>
</div>

<div class="row">
 <!-- Sidebar -->
 <div class="col-md-3">
 <div class="card border-0 shadow-sm mb-4">
 <div class="card-body text-center pt-5 pb-4">
 <div class="mb-3">
 {% if product.image %}
 <img src="{{ product.image.url }}" class="img-fluid rounded border shadow-sm"
 style="max-width: 150px; height: auto;" alt="{{ product.name }}">
 {% else %}
 <div class="rounded bg-secondary bg-opacity-10 d-inline-flex align-items-center justify-content-center"
 style="width: 100px; height: 100px;">
 <i class="bi bi-box-seam text-secondary display-4"></i>
 </div>
 {% endif %}
 </div>
 <h5 class="card-title mb-0">{{ product.name }}</h5>
 <p class="text-muted small">{{ product.sku|default:"Sem SKU" }}</p>
 {% if product.family %}
 <span class="badge bg-primary-subtle text-primary fw-normal">{{ product.family.name }}</span>
 {% endif %}
 </div>
 </div>

 <div class="card border-0 shadow-sm">
 <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center pt-3">
 <h6 class="mb-0 fw-bold">Estoque</h6>
 </div>
 <div class="card-body">
 <div class="mb-3">
 <label class="text-muted small d-block">Atual</label>
 <span
 class="fs-4 fw-bold {% if product.current_stock <= product.minimum_stock %}text-danger{% else %}text-success{% endif %}">
 {{ product.current_stock }}
 </span>
 </div>
 <div class="mb-3">
 <label class="text-muted small d-block">Mínimo</label>
 <span class="fw-medium">{{ product.minimum_stock }}</span>
 </div>
 <div class="mb-0">
 <label class="text-muted small d-block">Preço de Custo</label>
 <span class="fw-medium">R$ {{ product.cost_price }}</span>
 </div>
 </div>
 </div>
 </div>

 <!-- Main Content -->
 <div class="col-md-9">
 <div class="card border-0 shadow-sm">
 <div class="card-header bg-white border-bottom-0 pt-3 px-0 mx-3">
 <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
 <li class="nav-item" role="presentation">
 <button class="nav-link active" id="movements-tab" data-bs-toggle="tab"
 data-bs-target="#movements" type="button" role="tab">Movimentações</button>
 </li>
 <li class="nav-item" role="presentation">
 <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button"
 role="tab">Informações</button>
 </li>
 </ul>
 </div>
 <div class="card-body">
 <div class="tab-content" id="productTabsContent">
 <!-- Movimentações Tab -->
 <div class="tab-pane fade show active" id="movements" role="tabpanel">
 <div class="table-responsive">
 <table class="table table-hover align-middle">
 <thead class="bg-light">
 <tr>
 <th>Data</th>
 <th>Tipo</th>
 <th>Qtd</th>
 <th>Motivo</th>
 </tr>
 </thead>
 <tbody>
 {% for movement in movements %}
 <tr>
 <td>{{ movement.date|date:"d/m/Y" }}</td>
 <td>
 {% if movement.movement_type == 'IN' %}
 <span class="badge bg-success bg-opacity-10 text-success">Entrada</span>
 {% else %}
 <span class="badge bg-danger bg-opacity-10 text-danger">Saída</span>
 {% endif %}
 </td>
 <td>{{ movement.quantity }}</td>
 <td>{{ movement.reason }}</td>
 </tr>
 {% empty %}
 <tr>
 <td colspan="4" class="text-center text-muted py-4">Nenhuma movimentação
 recente.</td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>
 </div>

 <!-- Informações Tab -->
 <div class="tab-pane fade" id="info" role="tabpanel">
 <!-- Precificação -->
 <div class="card border-0 bg-light mb-4">
 <div
 class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
 <h6 class="mb-0 fw-bold">Precificação</h6>
 <a href="{% url 'estoque:product_update' product.id %}"
 class="btn btn-sm btn-link text-decoration-none p-0">Editar</a>
 </div>
 <div class="card-body">
 <div class="row">
 <div class="col-md-4">
 <label class="text-muted small d-block">Custo</label>
 <span class="fw-medium">R$ {{ product.cost_price }}</span>
 </div>
 <div class="col-md-4">
 <label class="text-muted small d-block">Margem</label>
 <span class="fw-medium">
 {% if product.cost_price > 0 %}
 {{ product.sale_price|add:product.cost_price|divisibleby:product.cost_price|linebreaksbr }}
 <!-- This logic is just a placeholder, real margin usually calculated in view/model -->
 {% with margin=product.sale_price|add:"-1" %}
 <!-- Simple diff for now, ideally percentage -->
 {% endwith %}
 -
 {% else %}
 -
 {% endif %}
 </span>
 </div>
 <div class="col-md-4">
 <label class="text-muted small d-block">Venda</label>
 <span class="fw-medium">R$ {{ product.sale_price }}</span>
 </div>
 </div>
 </div>
 </div>

 <!-- Dados Tributários -->
 <div class="card border-0 bg-light mb-4">
 <div
 class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
 <h6 class="mb-0 fw-bold">Dados Tributários</h6>
 <a href="{% url 'estoque:product_update' product.id %}"
 class="btn btn-sm btn-link text-decoration-none p-0">Editar</a>
 </div>
 <div class="card-body">
 <div class="row g-3">
 <div class="col-md-4">
 <label class="text-muted small d-block">NCM</label>
 <span class="fw-medium">{{ product.ncm|default:"Não informado" }}</span>
 </div>
 <div class="col-md-4">
 <label class="text-muted small d-block">CEST</label>
 <span class="fw-medium">{{ product.cest|default:"Não informado" }}</span>
 </div>
 <div class="col-md-12">
 <label class="text-muted small d-block">Origem do Produto</label>
 <span class="fw-medium">{{ product.get_product_origin_display }}</span>
 </div>
 </div>
 </div>
 </div>

 <!-- Dados Adicionais -->
 <div class="card border-0 bg-light mb-4">
 <div
 class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
 <h6 class="mb-0 fw-bold">Dados Adicionais</h6>
 <a href="{% url 'estoque:product_update' product.id %}"
 class="btn btn-sm btn-link text-decoration-none p-0">Editar</a>
 </div>
 <div class="card-body">
 <div class="row g-3">
 <div class="col-md-6">
 <label class="text-muted small d-block">Código do Fornecedor</label>
 <span class="fw-medium">{{ product.supplier_code|default:"Não informado" }}</span>
 </div>
 <div class="col-md-6">
 <label class="text-muted small d-block">Código de barras</label>
 <span class="fw-medium">{{ product.barcode|default:"Não informado" }}</span>
 </div>
 <div class="col-md-6">
 <label class="text-muted small d-block">Permite Estoque Negativo</label>
 <span class="fw-medium">{% if product.allow_negative_stock %}Sim{% else %}Não{% endif %}</span>
 </div>
 <div class="col-md-6">
 <label class="text-muted small d-block">Pode ser Locado</label>
 <span class="fw-medium">{% if product.can_be_rented %}Sim{% else %}Não{% endif %}</span>
 </div>
 </div>
 </div>
 </div>

 <div class="mb-3">
 <label class="text-muted small d-block">Descrição</label>
 <p>{{ product.description|default:"Sem descrição." }}</p>
 </div>
 <div class="mb-0">
 <label class="text-muted small d-block">Status</label>
 {% if product.active %}
 <span class="badge bg-success">Ativo</span>
 {% else %}
 <span class="badge bg-danger">Inativo</span>
 {% endif %}
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
</div>
{% endblock %}